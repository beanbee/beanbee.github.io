<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="记一个GTID复制bug"><meta name="keywords" content="MySQL,GTID,Replication,Bug"><meta name="author" content="Ian"><meta name="copyright" content="Ian"><title>记一个GTID复制bug | Beanbee's Blog</title><link rel="shortcut icon" href="/images/favicon.png"><link rel="stylesheet" href="/css/index.css?version=1.9.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://hm.baidu.com"><script>var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?7d4742d910f55cfca7b3b16d97046c4e";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();</script><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  hexoVersion: '5.4.2'
} </script><meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/blog/atom.xml" title="Beanbee's Blog" type="application/atom+xml">
</head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="false"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/images/favicon.png"></div><div class="author-info__name text-center">Ian</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">11</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">Tags</span><span class="pull-right">21</span></a><a class="author-info-articles__categories article-meta" href="/categories"><span class="pull-left">Categories</span><span class="pull-right">2</span></a></div><hr><div class="author-info-links"><div class="author-info-links__title text-center">Blogroll</div><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="https://kingsamchen.github.io/">kingsamchen</a><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="http://madstrawberry.me/">madstrawberry</a><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="http://functionghw.is-programmer.com">FunctionGHW</a><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="http://blog.51cto.com/ytyzzm">JamesSong</a><a class="author-info-links__name text-center" target="_blank" rel="noopener" href="http://sunus.me/">Sunus</a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(/images/default_top_image_beanbee.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Beanbee's Blog</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a></span><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> Search</span></a></span></div><div id="post-info"><div id="post-title">记一个GTID复制bug</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2018-05-31</time><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="/categories/workspace/">workspace</a></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>MySQL基于GTID的复制强调主从库GTID的连续和一致，比如主库如果执行了1-4，那从库IO线程拿到1-4的变更后，不管有没有被SQL线程过滤，从库的GTID也得保留1-4。</p>
<p>这就会出现一个现象：假定从库使用MySQL的过滤规则不执行主库发送的一部分变更（配置<code>replication-wild-do-table=A.%</code>，GTID&#x3D;uuid:2被过滤），那MySQL这个时候会在从库用空事务的方式填充binlog，从而保证uuid:2在从库不丢失，主从“GTID”一致。也就是说主从数据可以不一致，但是GTID一致。印证了“从GTID连续一致指标判断主从一致”的依据是不正确的。</p>
<p>那MySQL不做这个填充，会发生什么？一个是从库出现很多”GTID空隙“，<code>Executed_Gtid_Set</code>变得特别长。再者，如果某个期间你期望通过<code>MASTER_AUTO_POSITION=1</code>切换新主库，新主库一看从库缺了这么多”空隙“，那从自己的binlog里面找到发给从库让它补上，结果就是从库依旧过滤这些变更不执行，依旧补不上”空隙“。更多的时候切换的新主库会因为binlog rotate原因，包含“空隙GTID”的binlog已不存在，<code>CHANGE MASTER</code>持续报1236错误，切换不成功，非常恼火。</p>
<p>既然DBA显式指定的跳过一部分表的变更，GTID也得保持主库连续。从以往的使用经验来看，MySQL确实也是这么做的，而这次碰到的bug则是这个地方MySQL实现的不完善引起的。</p>
<p>BUG简述：在使用过滤选项进行GTID主从复制时，主库的CREATE DATABASE, ALTER DATABASE &amp; DROP DATABASE变更如果在从库被过滤，该GTID将不会在从库<code>Executed_Gtid_Set</code>中保留。</p>
<span id="more"></span>

<p>复现方法：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br></pre></td><td class="code"><pre><span class="line">master - my.cnf:</span><br><span class="line">log-bin                                 = mysql-bin</span><br><span class="line">gtid-mode                               = ON</span><br><span class="line">log-slave-updates                       = ON</span><br><span class="line">enforce-gtid-consistency                = ON</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">slave - my.cnf:</span><br><span class="line">replicate-wild-do-table                 = mydb1.%</span><br><span class="line">gtid-mode                               = ON</span><br><span class="line">log-slave-updates                       = ON</span><br><span class="line">enforce-gtid-consistency                = ON</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line">master status information:</span><br><span class="line">mysql&gt; show master status ;</span><br><span class="line">+------------------+----------+--------------+------------------+--------------------------------------------+</span><br><span class="line">| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set                          |</span><br><span class="line">+------------------+----------+--------------+------------------+--------------------------------------------+</span><br><span class="line">| mysql-bin.000002 |      627 |              |                  | 356d0651-5e4c-11e8-846c-126bb17ce918:1-345 |</span><br><span class="line">+------------------+----------+--------------+------------------+--------------------------------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.01 sec)</span><br><span class="line"></span><br><span class="line">replication status of slave:</span><br><span class="line">mysql&gt; show slave status \G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">               Slave_IO_State: Waiting <span class="keyword">for</span> master to send event</span><br><span class="line">                  Master_Host: 10.23.7.81</span><br><span class="line">                  Master_User: slave</span><br><span class="line">                  Master_Port: 3306</span><br><span class="line">                Connect_Retry: 60</span><br><span class="line">              Master_Log_File: mysql-bin.000002</span><br><span class="line">          Read_Master_Log_Pos: 627</span><br><span class="line">               Relay_Log_File: freewheel-relay-bin.000002</span><br><span class="line">                Relay_Log_Pos: 554</span><br><span class="line">        Relay_Master_Log_File: mysql-bin.000002</span><br><span class="line">             Slave_IO_Running: Yes</span><br><span class="line">            Slave_SQL_Running: Yes</span><br><span class="line">              Replicate_Do_DB:</span><br><span class="line">          Replicate_Ignore_DB:</span><br><span class="line">           Replicate_Do_Table:</span><br><span class="line">       Replicate_Ignore_Table:</span><br><span class="line">      Replicate_Wild_Do_Table: mydb1.%</span><br><span class="line">  Replicate_Wild_Ignore_Table:</span><br><span class="line">                   Last_Errno: 0</span><br><span class="line">                   Last_Error:</span><br><span class="line">                 Skip_Counter: 0</span><br><span class="line">          Exec_Master_Log_Pos: 627</span><br><span class="line">              Relay_Log_Space: 762</span><br><span class="line">              Until_Condition: None</span><br><span class="line">               Until_Log_File:</span><br><span class="line">                Until_Log_Pos: 0</span><br><span class="line">           Master_SSL_Allowed: No</span><br><span class="line">           Master_SSL_CA_File:</span><br><span class="line">           Master_SSL_CA_Path:</span><br><span class="line">              Master_SSL_Cert:</span><br><span class="line">            Master_SSL_Cipher:</span><br><span class="line">               Master_SSL_Key:</span><br><span class="line">        Seconds_Behind_Master: 0</span><br><span class="line">Master_SSL_Verify_Server_Cert: No</span><br><span class="line">                Last_IO_Errno: 0</span><br><span class="line">                Last_IO_Error:</span><br><span class="line">               Last_SQL_Errno: 0</span><br><span class="line">               Last_SQL_Error:</span><br><span class="line">  Replicate_Ignore_Server_Ids:</span><br><span class="line">             Master_Server_Id: 27087</span><br><span class="line">                  Master_UUID: 356d0651-5e4c-11e8-846c-126bb17ce918</span><br><span class="line">             Master_Info_File: /home/mysql/data/master.info</span><br><span class="line">                    SQL_Delay: 0</span><br><span class="line">          SQL_Remaining_Delay: NULL</span><br><span class="line">      Slave_SQL_Running_State: Slave has <span class="built_in">read</span> all relay <span class="built_in">log</span>; waiting <span class="keyword">for</span> the slave I/O thread to update it</span><br><span class="line">           Master_Retry_Count: 86400</span><br><span class="line">                  Master_Bind:</span><br><span class="line">      Last_IO_Error_Timestamp:</span><br><span class="line">     Last_SQL_Error_Timestamp:</span><br><span class="line">               Master_SSL_Crl:</span><br><span class="line">           Master_SSL_Crlpath:</span><br><span class="line">           Retrieved_Gtid_Set: 356d0651-5e4c-11e8-846c-126bb17ce918:345</span><br><span class="line">            Executed_Gtid_Set: 356d0651-5e4c-11e8-846c-126bb17ce918:1-345</span><br><span class="line">                Auto_Position: 1</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">Here<span class="string">&#x27;re steps to verify:</span></span><br><span class="line"><span class="string">1. Send INSERT on mydb1.t on master</span></span><br><span class="line"><span class="string">master - GTID+1:</span></span><br><span class="line"><span class="string">mysql&gt; insert into mydb1.t values (1);</span></span><br><span class="line"><span class="string">Query OK, 1 row affected (0.00 sec)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">mysql&gt; show master status ;</span></span><br><span class="line"><span class="string">+------------------+----------+--------------+------------------+--------------------------------------------+</span></span><br><span class="line"><span class="string">| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set                          |</span></span><br><span class="line"><span class="string">+------------------+----------+--------------+------------------+--------------------------------------------+</span></span><br><span class="line"><span class="string">| mysql-bin.000002 |      859 |              |                  | 356d0651-5e4c-11e8-846c-126bb17ce918:1-346 |</span></span><br><span class="line"><span class="string">+------------------+----------+--------------+------------------+--------------------------------------------+</span></span><br><span class="line"><span class="string">1 row in set (0.00 sec)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">slave - GTID+1:</span></span><br><span class="line"><span class="string">mysql&gt; show slave status \G</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="string">      Replicate_Wild_Do_Table: mydb1.%</span></span><br><span class="line"><span class="string">           Retrieved_Gtid_Set: 356d0651-5e4c-11e8-846c-126bb17ce918:345-346</span></span><br><span class="line"><span class="string">            Executed_Gtid_Set: 356d0651-5e4c-11e8-846c-126bb17ce918:1-346</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">2. Send INSERT on mydb2.t on master</span></span><br><span class="line"><span class="string">master - GTID+1:</span></span><br><span class="line"><span class="string">mysql&gt; insert into mydb2.t values (1);</span></span><br><span class="line"><span class="string">Query OK, 1 row affected (0.00 sec)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">mysql&gt; show master status ;</span></span><br><span class="line"><span class="string">+------------------+----------+--------------+------------------+--------------------------------------------+</span></span><br><span class="line"><span class="string">| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set                          |</span></span><br><span class="line"><span class="string">+------------------+----------+--------------+------------------+--------------------------------------------+</span></span><br><span class="line"><span class="string">| mysql-bin.000002 |     1091 |              |                  | 356d0651-5e4c-11e8-846c-126bb17ce918:1-347 |</span></span><br><span class="line"><span class="string">+------------------+----------+--------------+------------------+--------------------------------------------+</span></span><br><span class="line"><span class="string">1 row in set (0.00 sec)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">mysql&gt; select * from mydb2.t;</span></span><br><span class="line"><span class="string">+------+</span></span><br><span class="line"><span class="string">| x    |</span></span><br><span class="line"><span class="string">+------+</span></span><br><span class="line"><span class="string">|    1 |</span></span><br><span class="line"><span class="string">+------+</span></span><br><span class="line"><span class="string">1 row in set (0.00 sec)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">slave - GTID+1:</span></span><br><span class="line"><span class="string">mysql&gt; select * from mydb2.t;</span></span><br><span class="line"><span class="string">Empty set (0.00 sec)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">mysql&gt; show slave status \G</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="string">      Replicate_Wild_Do_Table: mydb1.%</span></span><br><span class="line"><span class="string">           Retrieved_Gtid_Set: 356d0651-5e4c-11e8-846c-126bb17ce918:345-347</span></span><br><span class="line"><span class="string">            Executed_Gtid_Set: 356d0651-5e4c-11e8-846c-126bb17ce918:1-347</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">3. Send CREATE DATABASE xxx on master</span></span><br><span class="line"><span class="string">master - GTID+1:</span></span><br><span class="line"><span class="string">mysql&gt; create database mydb3;</span></span><br><span class="line"><span class="string">Query OK, 1 row affected (0.00 sec)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">mysql&gt; show master status ;</span></span><br><span class="line"><span class="string">+------------------+----------+--------------+------------------+--------------------------------------------+</span></span><br><span class="line"><span class="string">| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set                          |</span></span><br><span class="line"><span class="string">+------------------+----------+--------------+------------------+--------------------------------------------+</span></span><br><span class="line"><span class="string">| mysql-bin.000002 |     1236 |              |                  | 356d0651-5e4c-11e8-846c-126bb17ce918:1-348 |</span></span><br><span class="line"><span class="string">+------------------+----------+--------------+------------------+--------------------------------------------+</span></span><br><span class="line"><span class="string">1 row in set (0.00 sec)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">slave - GTID retrieved but not changed on Executed_Gtid_Set:  =&gt; 丢失一个GTID</span></span><br><span class="line"><span class="string">mysql&gt; show slave status \G</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="string">      Replicate_Wild_Do_Table: mydb1.%</span></span><br><span class="line"><span class="string">           Retrieved_Gtid_Set: 356d0651-5e4c-11e8-846c-126bb17ce918:345-348</span></span><br><span class="line"><span class="string">            Executed_Gtid_Set: 356d0651-5e4c-11e8-846c-126bb17ce918:1-347</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">4. Send INSERT on mydb1.t on master</span></span><br><span class="line"><span class="string">master - GTID+1:</span></span><br><span class="line"><span class="string">mysql&gt; insert into mydb1.t values (1);</span></span><br><span class="line"><span class="string">Query OK, 1 row affected (0.00 sec)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">mysql&gt; show master status ;</span></span><br><span class="line"><span class="string">+------------------+----------+--------------+------------------+--------------------------------------------+</span></span><br><span class="line"><span class="string">| File             | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set                          |</span></span><br><span class="line"><span class="string">+------------------+----------+--------------+------------------+--------------------------------------------+</span></span><br><span class="line"><span class="string">| mysql-bin.000002 |     1468 |              |                  | 356d0651-5e4c-11e8-846c-126bb17ce918:1-349 |</span></span><br><span class="line"><span class="string">+------------------+----------+--------------+------------------+--------------------------------------------+</span></span><br><span class="line"><span class="string">1 row in set (0.00 sec)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">slave - broken GTID set on Executed_Gtid_Set:             =&gt; 出现GTID空隙</span></span><br><span class="line"><span class="string">...</span></span><br><span class="line"><span class="string">      Replicate_Wild_Do_Table: mydb1.%</span></span><br><span class="line"><span class="string">           Retrieved_Gtid_Set: 356d0651-5e4c-11e8-846c-126bb17ce918:345-349</span></span><br><span class="line"><span class="string">            Executed_Gtid_Set: 356d0651-5e4c-11e8-846c-126bb17ce918:1-347:349</span></span><br><span class="line"><span class="string">...</span></span><br></pre></td></tr></table></figure>

<p>反馈bug后得到<a target="_blank" rel="noopener" href="https://bugs.mysql.com/bug.php?id=91086">官方回复</a>，已经在新版本<em>8.0.12, 5.7.23, 5.6.41</em>中修复，虽然都还没有release：</p>
<blockquote>
<p>Thanks for the report. Changelog entry added for MySQL 8.0.12, 5.7.23, and 5.6.41:</p>
<p>When GTIDs are in use for replication, replicated transactions that are filtered out on the slave are persisted. If binary logging is enabled on the slave, the filtered-out transaction is written to the binary log as a Gtid_log_event followed by an empty transaction containing only BEGIN and COMMIT statements. If binary logging is disabled, the GTID of the filtered-out transaction is written to the mysql.gtid_executed table. This process ensures that there are no gaps in the set of executed GTIDs, and that the filtered-out transactions are not retrieved again if the slave reconnects to the master. Previously, this process was not done for CREATE DATABASE, ALTER DATABASE, and DROP DATABASE statements, but it is now carried out for those statements as well as for others.</p>
</blockquote>
<p>总结的话，现阶段如果用了过滤选项<code>replicate-*-table</code>进行复制，避免在主库进行CREATE&#x2F;DROP&#x2F;ALTER DATABASE操作，否则会引起该GTID在从库<code>Executed_Gtid_Set</code>中缺失。当然建议还是少用<code>replicate-*-table</code></p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">Ian</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://beanbee.github.io/blog/2018/bug-report-of-gtid-replicaiton-91086/">https://beanbee.github.io/blog/2018/bug-report-of-gtid-replicaiton-91086/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/MySQL/">MySQL</a><a class="post-meta__tags" href="/tags/GTID/">GTID</a><a class="post-meta__tags" href="/tags/Replication/">Replication</a><a class="post-meta__tags" href="/tags/Bug/">Bug</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/blog/2018/how-osc-handle-table-with-fk/"><i class="fa fa-chevron-left">  </i><span>OSC工具如何处理外键约束</span></a></div><div class="next-post pull-right"><a href="/blog/2018/avoid-err-master-purged-gtids-required/"><span>判断GTID切换是否会出现Error:1236问题</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="disqus_thread"></div><script>var unused = null;
var disqus_config = function () {
  this.page.url = 'https://beanbee.github.io/blog/2018/bug-report-of-gtid-replicaiton-91086/';
  this.page.identifier = 'blog/2018/bug-report-of-gtid-replicaiton-91086/';
  this.page.title = '记一个GTID复制bug';
}
var d = document, s = d.createElement('script');
s.src = "https://" + 'beanbee' +".disqus.com/embed.js";
s.setAttribute('data-timestamp', '' + +new Date());
(d.head || d.body).appendChild(s);</script></div></div><footer class="footer-bg" style="background-image: url(/images/default_top_image_beanbee.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2022 By Ian</div><div class="framework-info"><span>Driven - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.0"></script><script src="/js/fancybox.js?version=1.9.0"></script><script src="/js/sidebar.js?version=1.9.0"></script><script src="/js/copy.js?version=1.9.0"></script><script src="/js/fireworks.js?version=1.9.0"></script><script src="/js/transition.js?version=1.9.0"></script><script src="/js/scroll.js?version=1.9.0"></script><script src="/js/head.js?version=1.9.0"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
  tex2jax: {
    inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
    processEscapes: true,
    skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
  },
  CommonHTML: {
    linebreaks: { automatic: true, width: "90% container" }
  },
  "HTML-CSS": { 
    linebreaks: { automatic: true, width: "90% container" }
  },
  "SVG": { 
    linebreaks: { automatic: true, width: "90% container" }
  }
});
</script><script type="text/x-mathjax-config">MathJax.Hub.Queue(function() {
  var all = MathJax.Hub.getAllJax(), i;
  for (i=0; i < all.length; i += 1) {
    all[i].SourceElement().parentNode.className += ' has-jax';
  }
});
</script><script src="https://cdn.jsdelivr.net/npm/mathjax/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script src="/js/search/local-search.js"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">Local search</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>Powered by</span> <a target="_blank" rel="noopener" href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>